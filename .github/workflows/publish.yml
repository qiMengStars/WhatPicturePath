# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build and Publish Release

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: |
        dotnet restore
      working-directory: ./WhatPicturePath

    - name: Build portable executable (without runtime)
      run: |
        dotnet publish -c Release -r win-x64 --self-contained false -o ./publish/portable -p:PublishTrimmed=false -p:Optimize=true -p:UseAppHost=true
      working-directory: ./WhatPicturePath

    - name: Build standalone executable (with embedded runtime)
      run: |
        dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:PublishTrimmed=false -p:Optimize=true -o ./publish/standalone
      working-directory: ./WhatPicturePath

    - name: Rename portable executable
      run: |
        ren ".\publish\portable\WhatPicturePath.exe" "WhatPicturePath_Portable.exe"
        ren ".\publish\portable\WhatPicturePath.dll" "WhatPicturePath_Portable.dll"
      shell: cmd
      working-directory: ./WhatPicturePath

    - name: Rename standalone executable
      run: |
        ren ".\publish\standalone\WhatPicturePath.exe" "WhatPicturePath_Standalone.exe"
      shell: cmd
      working-directory: ./WhatPicturePath

    - name: Copy portable files to single directory
      run: |
        mkdir portable_final
        copy ".\publish\portable\WhatPicturePath_Portable.exe" ".\portable_final\WhatPicturePath_Portable.exe"
        copy ".\publish\portable\WhatPicturePath_Portable.dll" ".\portable_final\WhatPicturePath_Portable.dll"
      shell: cmd
      working-directory: ./WhatPicturePath

    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: portable-executable
        path: ./WhatPicturePath/portable_final/*

    - name: Upload standalone artifact
      uses: actions/upload-artifact@v4
      with:
        name: standalone-executable
        path: ./WhatPicturePath/publish/standalone/WhatPicturePath_Standalone.exe

  release:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Download portable executable
      uses: actions/download-artifact@v4
      with:
        name: portable-executable
        path: ./portable

    - name: Download standalone executable
      uses: actions/download-artifact@v4
      with:
        name: standalone-executable
        path: ./standalone

    - name: List portable directory contents
      run: dir "portable"
      shell: cmd

    - name: List standalone directory contents
      run: dir "standalone"
      shell: cmd

    - name: Get current date for release notes
      run: |
        echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      shell: bash

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Release ${{ github.run_number }} - ${{ env.RELEASE_DATE }}
        draft: false
        prerelease: false
        body: |
          Release ${{ github.run_number }} built on ${{ env.RELEASE_DATE }}

          ## Artifacts
          - WhatPicturePath_Portable.exe + WhatPicturePath_Portable.dll: Portable version (requires .NET 10.0 runtime installed)
          - WhatPicturePath_Standalone.exe: Standalone version (includes runtime, recommended for most users)

          ## Usage Notes
          - **Portable Version**: Requires .NET 10.0 Desktop Runtime to be installed on the target machine. Download from [Microsoft](https://dotnet.microsoft.com/download/dotnet/10.0). Both .exe and .dll files must be in the same directory.
          - **Standalone Version**: Contains all necessary runtime components. Works on any Windows 10/11 machine without additional installations.
        files: |
          ./portable/WhatPicturePath_Portable.exe
          ./portable/WhatPicturePath_Portable.dll
          ./standalone/WhatPicturePath_Standalone.exe